# Workflow for Creating GitPOAPs

This guide outlines the process for creating GitPOAPs. It should be updated whenever the backend changes
things related to GitPOAP creation or the various automation steps handled by the backend.

## General Steps

1. Ensure that the Project owners know that we will be skipping all forks if they choose to include "all" of
   the repos in their GitHub organizations. If they confirm they want to include additional forks we can
   can perform we can add them during step 4 (if using the second bulleted option) or add it to the list
   generated by step 7.
2. Open up a shell terminal.
3. [Choose how](https://github.com/gitpoap/gitpoap-backend/blob/main/docs/GitPOAP-Creation-Workflow.md#setting-env-variables)
    to set `GITHUB_ACCESS_TOKEN` in the ENV.
4. Clone [`count-yearly-contributors`](https://github.com/gitpoap/count-yearly-contributors), and:
    * For a set of repos like `foo/bar gitpoap/gitpoap-backend` (or just one), run the command:
        ```sh
        ./count.py --repos foo/bar gitpoap/gitpoap-backend
        ```
    * For a set of orgs like `foo gitpoap` (or just one), run the command:
        ```sh
        ./count.py --orgs foo gitpoap
        ```
5. This command will output (in a new folder) two files. One will be named something like `*counts.csv`.
    Within this file there is a listing of the number of contributors for each year to the repos/orgs that
    were specified like:
    ```csv
    year,contributorCount
    2021,3
    2022,6
    ```
6. Head over to the [admin page for creating multiple GitPOAPs](https://www.gitpoap.io/admin/gitpoap/create-multiple),
    and create a GitPOAP for each year that was output, using the corresponding `contributorCount` for that year as a guide.
    It is good practice to add 10-20 extra codes as a buffer for a previous year and 40-50 for the current year. **Ensure
    that the current year is marked as "ongoing"!**
7. Since the current admin UI only lets a single repo be added per GitPOAP at this time (this will be updated at some point),
    we need to now add the remaining repositories to the repository. If you started with a set of repos already, you can
    skip this step. If not, we need to use the script from [`organization-repos`](https://github.com/gitpoap/organization-repos)
    to collect all the repositories that are not forks:
    ```sh
    ./repos.py foo gitpoap
    ```
    which will output a list of repos on separate lines.
8. Now grab a GitPOAP JWT token by (assuming firefox or chrome) by:
    1. Navigating to https://gitpoap.io (or **refreshing** an open page)
    2. Left clicking anywhere and selecting something like the option "Inspect"
    3. Clicking on the "Storage" tab and then the "Local Storage"
    4. Copying the value (with parentheses included) for the key "accessToken"
9. [Set](https://github.com/gitpoap/gitpoap-backend/blob/main/docs/GitPOAP-Creation-Workflow.md#setting-env-variables)
    `GITPOAP_ACCESS_TOKEN` in the ENV (*don't* put this one in `~/.bashrc` since it expires every 10 minutes)
10. Run [`add-repos-to-project`](https://github.com/gitpoap/add-repos-to-project) with the repos printed out during step 7
    to add the repos to an existing project (it will confirm that everything looks right). You should use the `--repo-path`
    option to help pick the correct Project and supply it the name of the repo used in step 6:
    ```sh
    ./add-repos-to-project.py -b https://api.gitpoap.io --repo-path step-6/repo-name --new-repos new/repos go/here
    ```
    The background backloading process on the backend will automatically create claims for these repos.

## Creating New Claims for a Custom List of Users

We can create Claims for a custom list of Users for some Project using the
[`create-claims`](https://github.com/gitpoap/create-claims) tool so long as we have at minimum a CSV containing:
* The first two columns `year` and `githubHandle` (using the `--claims-by-handle` flag)
* The first two columns `year` and `githubId` (using the `--claims-by-id` flag)

See [the appendix](https://github.com/gitpoap/gitpoap-backend/blob/main/docs/GitPOAP-Creation-Workflow.md#extracting-or-rearranging-columns-in-csv-files)
for info on how to extract this from larger sets of data (possibly in the incorrect order).

For this script to run, both `GITHUB_ACCESS_TOKEN` and `GITPOAP_ACCESS_TOKEN` must be set in the ENV. Given:
* Some Repo ID:
    ```sh
    ./create.py -u https://api.gitpoap.io -repo-id 34 --claims-by-id claims-by-id-file.csv
    ```
* Some Repo name in the Project:
    ```sh
    ./create.py -u https://api.gitpoap.io -repo-name some/repo --claims-by-id claims-by-id-file.csv
    ```

Note that the both these options require that the CSV file have headers describing the columns (if not, the tool will
exit and it should be obvious what to fix from the printout).

## Appendix

### Setting ENV variables

There's a few ways that one can set environment variables in the shell:
* Prefixing the command with the environment:
    ```sh
    SOME_VAR=foo ./command.sh ...
    ```
    Note that this will have to be repeated for *every* command that needs that ENV variable.
* Exporting the command in the shell before running the command:
    ```sh
    export SOME_VAR=foo

    # Now you can run a bunch of commands that use the ENV var
    # without needed to resissue the above command
    ./command.sh
    ./other-command.sh
    ```
* Setting the ENV variable in `~/.bashrc`, by adding the line `export SOME_VAR=foo`: By doing this
    the command will already be set every time you open the shell. Note that this is probably best
    not to do with variable that will need to be reset frequently.

### Extracting or rearranging columns in CSV files

To extract specific columns in a CSV file we can use the tool `awk` in a shell terminal. For instance:
* Selecting only columns 1 and 7:
    ```sh
    cat some-file.csv | awk -F, '{OFS=","; print $1, $7}' > some-new-file.csv
    ```
* Selecting only columns 1 and 7 (but in opposite order):
    ```sh
    cat some-file.csv | awk -F, '{OFS=","; print $7, $1}' > some-new-file.csv
    ```
